-- NoFog.lua
-- Módulo para remover e restaurar fog e efeitos visuais do Lighting

local NoFog = {}
NoFog.enabled = false
NoFog._connections = {}
NoFog._original = nil

-- Lista de efeitos suportados
local EFFECT_TYPES = {
    "Atmosphere",
    "BloomEffect", 
    "ColorCorrectionEffect",
    "DepthOfFieldEffect",
    "SunRaysEffect"
}

local function isTargetEffect(obj)
    for _, effectType in ipairs(EFFECT_TYPES) do
        if obj:IsA(effectType) then
            return true
        end
    end
    return false
end

function NoFog:apply()
    local Lighting = game:GetService("Lighting")
    
    -- Remove fog
    Lighting.FogEnd = 1e10
    Lighting.FogStart = 1e10 - 1
    Lighting.FogColor = Color3.new(1, 1, 1)
    
    -- Remove efeitos visuais
    for _, v in ipairs(Lighting:GetChildren()) do
        if isTargetEffect(v) then
            v:Destroy()
        end
    end
end

function NoFog:saveOriginal()
    local Lighting = game:GetService("Lighting")
    
    -- Limpa efeitos anteriores se existirem
    if self._original and self._original.Effects then
        for _, effect in ipairs(self._original.Effects) do
            if effect and effect.Destroy then
                effect:Destroy()
            end
        end
    end
    
    self._original = {
        FogStart = Lighting.FogStart,
        FogEnd = Lighting.FogEnd,
        FogColor = Lighting.FogColor,
        Effects = {}
    }
    
    -- Salva cópias dos efeitos atuais
    for _, v in ipairs(Lighting:GetChildren()) do
        if isTargetEffect(v) then
            table.insert(self._original.Effects, v:Clone())
        end
    end
end

function NoFog:restoreOriginal()
    local Lighting = game:GetService("Lighting")
    if not self._original then return end
    
    -- Restaura propriedades do fog
    Lighting.FogStart = self._original.FogStart
    Lighting.FogEnd = self._original.FogEnd
    Lighting.FogColor = self._original.FogColor
    
    -- Remove efeitos atuais
    for _, v in ipairs(Lighting:GetChildren()) do
        if isTargetEffect(v) then
            v:Destroy()
        end
    end
    
    -- Restaura efeitos originais
    for _, effect in ipairs(self._original.Effects) do
        if effect and effect.Parent == nil then -- Verifica se ainda é válido
            local restored = effect:Clone()
            restored.Parent = Lighting
        end
    end
end

function NoFog:enable()
    if self.enabled then return end
    
    self.enabled = true
    self:saveOriginal()
    self:apply()
    
    -- Conecta eventos para re-aplicar quando novos efeitos forem adicionados
    table.insert(self._connections, game:GetService("Lighting").ChildAdded:Connect(function(child)
        if self.enabled and isTargetEffect(child) then
            child:Destroy()
        end
    end))
end

function NoFog:disable()
    if not self.enabled then return end
    
    self.enabled = false
    
    -- Desconecta todos os eventos
    for _, conn in ipairs(self._connections) do
        if conn and conn.Disconnect then 
            conn:Disconnect() 
        end
    end
    self._connections = {}
    
    -- Restaura configurações originais
    self:restoreOriginal()
end

function NoFog:cleanup()
    self:disable()
    
    -- Limpa efeitos salvos da memória
    if self._original and self._original.Effects then
        for _, effect in ipairs(self._original.Effects) do
            if effect and effect.Destroy then
                effect:Destroy()
            end
        end
    end
    self._original = nil
end

-- Método para verificar se está habilitado
function NoFog:isEnabled()
    return self.enabled
end

return NoFog
