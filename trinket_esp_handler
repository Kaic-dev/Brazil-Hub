local Workspace = game:GetService("Workspace")
local ConnectionManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/Kaic-dev/Brazil-Hub/main/ConnectionManager"))()

local MESH_IDS = {
    ["rbxassetid://5196551436"] = "Amulet",
    ["rbxassetid://5196577540"] = "Old Amulet",
    ["rbxassetid://5204003946"] = "Goblet",
    ["rbxassetid://5196782997"] = "Old Ring",
    ["rbxassetid://5196776695"] = "Ring",
    ["rbxassetid://5204453430"] = "Scroll",
    ["rbxassetid://2877143560"] = "Ruby",
    ["rbxassetid://2877143592"] = "Sapphire",
    ["rbxassetid://2877143624"] = "Emerald",
    ["rbxassetid://2520762076"] = "Howler Friend"
}

local PHOENIX_TEXTURE = "rbxassetid://1536547385"
local BILLBOARD_SIZE = UDim2.new(0, 100, 0, 100)

local function cleanMeshId(id)
    return tostring(id):gsub("%%20", ""):gsub("%s+", "")
end

local function getTrinketName(part)
    if part.Material == Enum.Material.Slate and part:FindFirstChildOfClass("ParticleEmitter") then
        return "Idol of the Forgotten"
    end
    
    if part.Material == Enum.Material.Neon then
        return part:FindFirstChildOfClass("PointLight") and "Amulet of the White King" or "Nightstone"
    end
    
    if part.Transparency == 1 then
        local hasOrb, hasLight, hasSphere = false, false, false
        local children = part:GetChildren()
        
        for i = 1, #children do
            local child = children[i]
            local childType = child.ClassName
            
            if childType == "ParticleEmitter" and child.Name == "OrbParticle" then
                hasOrb = true
            elseif childType == "PointLight" then
                hasLight = true
            elseif childType == "SpecialMesh" and child.MeshType == Enum.MeshType.Sphere then
                hasSphere = true
            elseif childType == "Attachment" then
                local attachChildren = child:GetChildren()
                for j = 1, #attachChildren do
                    local subChild = attachChildren[j]
                    if subChild.ClassName == "ParticleEmitter" and tostring(subChild.Texture) == PHOENIX_TEXTURE then
                        return "Phoenix Down"
                    end
                end
            end
        end
        
        if hasOrb and hasLight and hasSphere then
            return "???"
        end
    end
    
    local meshId = part:IsA("MeshPart") and part.MeshId or 
                  (part:FindFirstChildWhichIsA("SpecialMesh") or part:FindFirstChildWhichIsA("Mesh") or {}).MeshId
    
    return meshId and (MESH_IDS[cleanMeshId(meshId)] or meshId) or "Unknown"
end

local TrinketESP = {}
TrinketESP.__index = TrinketESP

function TrinketESP.new()
    return setmetatable({
        espBillboards = {},
        _connectionManager = ConnectionManager.new(),
        enabled = false
    }, TrinketESP)
end

function TrinketESP:isTrinket(obj)
    return (obj.ClassName == "Part" or obj.ClassName == "MeshPart") and obj:FindFirstChild("ID")
end

function TrinketESP:onChildAdded(obj)
    if not self.enabled or not self:isTrinket(obj) then return end
    
    local trinketName = getTrinketName(obj)
    self:createBillboard(obj, trinketName)
end

function TrinketESP:onChildRemoved(obj)
    if not self.enabled or not self.espBillboards[obj] then return end
    
    self:removeBillboard(obj)
end

function TrinketESP:createBillboard(trinket, trinketName)
    if self.espBillboards[trinket] then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "TrinketESP"
    billboard.Adornee = trinket
    billboard.LightInfluence = 1
    billboard.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    billboard.AlwaysOnTop = true
    billboard.Size = BILLBOARD_SIZE
    billboard.Parent = trinket

    local label = Instance.new("TextLabel")
    label.Text = trinketName
    label.TextColor3 = Color3.new(0.615, 0.615, 0.615)
    label.TextStrokeTransparency = 0.5
    label.Font = Enum.Font.SourceSans
    label.TextSize = 14
    label.BackgroundTransparency = 1
    label.BorderSizePixel = 0
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Position = UDim2.new(0.5, 0, 0.5, 0)
    label.AnchorPoint = Vector2.new(0.5, 0.5)
    label.Parent = billboard

    self.espBillboards[trinket] = billboard
end

function TrinketESP:removeBillboard(trinket)
    local billboard = self.espBillboards[trinket]
    if billboard then
        billboard:Destroy()
        self.espBillboards[trinket] = nil
    end
end

function TrinketESP:scanExistingTrinkets()
    local workspaceChildren = Workspace:GetChildren()
    
    for i = 1, #workspaceChildren do
        local obj = workspaceChildren[i]
        if self:isTrinket(obj) then
            local trinketName = getTrinketName(obj)
            self:createBillboard(obj, trinketName)
        end
    end
end

function TrinketESP:enable()
    if self.enabled then return end
    
    self.enabled = true
    
    self:scanExistingTrinkets()
    
    self._connectionManager:add(Workspace.ChildAdded:Connect(function(obj)
        self:onChildAdded(obj)
    end))
    
    self._connectionManager:add(Workspace.ChildRemoved:Connect(function(obj)
        self:onChildRemoved(obj)
    end))
end

function TrinketESP:disable()
    self.enabled = false
    self._connectionManager:disconnectAll()
    
    for trinket in pairs(self.espBillboards) do
        self:removeBillboard(trinket)
    end
end

function TrinketESP:destroy()
    self:disable()
    self._connectionManager = nil
    self.espBillboards = nil
end

return TrinketESP
